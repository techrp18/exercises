<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hand & Elbow Drawing Board</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      height:100vh;display:flex;flex-direction:column;overflow:hidden
    }
    .header{background:rgba(0,0,0,.8);color:#fff;text-align:center;padding:10px;backdrop-filter:blur(10px)}
    .main-container{flex:1;position:relative;overflow:hidden; background-color: #000;}
    #videoContainer{position:absolute;inset:0;}
    #video{width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #drawingCanvas{position:absolute;inset:0;z-index:2}
    .controls{
      position:absolute;bottom:20px;left:50%;transform:translateX(-50%);
      display:flex;gap:12px;background:rgba(0,0,0,.8);padding:12px 16px;border-radius:22px;
      backdrop-filter:blur(10px);z-index:10;flex-wrap:wrap;justify-content:center
    }
    .control-btn{
      padding:10px 16px;border:none;border-radius:18px;cursor:pointer;font-weight:700;
      transition:.2s;display:flex;align-items:center;gap:8px;font-size:14px;color:#fff
    }
    .control-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.3)}
    .clear-btn{background:linear-gradient(45deg,#ffa726,#ff9800)}
    .calibrate-btn{background:linear-gradient(45deg,#2196f3,#1976d2)}
    .settings{
      position:absolute;top:20px;right:20px;background:rgba(0,0,0,.8);padding:14px;border-radius:14px;
      backdrop-filter:blur(10px);z-index:10;color:#fff;min-width:240px
    }
    .setting-item{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
    .setting-item:last-child{margin-bottom:0}
    .setting-item input[type="range"]{width:120px}
    .color-picker{width:36px;height:36px;border:none;border-radius:50%;cursor:pointer;background:transparent}
    .status{
      position:absolute;top:20px;left:20px;background:rgba(0,0,0,.8);color:#fff;padding:12px;border-radius:10px;backdrop-filter:blur(10px);z-index:10;max-width:360px
    }
    .instructions{
      position:absolute;top:50%;left:20px;transform:translateY(-50%);
      background:rgba(0,0,0,.8);color:#fff;padding:16px;border-radius:12px;backdrop-filter:blur(10px);z-index:10
    }
    .instructions h3{margin-bottom:8px;color:#2196f3}
    .instructions ul{list-style:none;line-height:1.7}
    .instructions li{margin-bottom:4px;padding-left:18px;position:relative}
    .instructions li:before{content:"‚Üí";position:absolute;left:0;color:#2196f3}
    .loading{
      position:absolute;inset:0;margin:auto;height:max-content;width:max-content;
      background:rgba(0,0,0,.9);color:#fff;padding:24px;border-radius:14px;z-index:20;text-align:center;display:none
    }
    .crosshair{
      position:absolute;width:28px;height:28px;border:2px solid #00ff00;border-radius:50%;
      transform:translate(-50%,-50%);pointer-events:none;z-index:5;opacity:0;transition:opacity .2s
    }
    .crosshair.active{opacity:1;box-shadow:0 0 20px rgba(0,255,0,.6)}
  </style>
</head>
<body>
  <div class="header">
  </div>

  <div id="mainContainer" class="main-container">
    <div id="loading" class="loading"></div>
    <div id="videoContainer">
      <video id="video" autoplay muted playsinline></video>
      <div id="crosshair" class="crosshair"></div>
    </div>
    <canvas id="drawingCanvas"></canvas>
  </div>

  <audio id="backgroundMusic" src="musicbg.mp3" loop preload="auto"></audio>

  <div id="instructions" class="instructions"></div>

  

  <div class="controls">
    <button id="clearBtn" class="control-btn clear-btn">üóëÔ∏è Clear All</button>
    <button id="calibrateBtn" class="control-btn calibrate-btn">üéØ Recalibrate Pointer</button>
  </div>

  <div class="settings">
    <div class="setting-item">
      <label>Draw Color:</label>
      <input type="color" id="colorPicker" class="color-picker" value="#00ff00"/>
    </div>
    <div class="setting-item">
      <label>Brush Size:</label>
      <input type="range" id="brushSize" min="2" max="50" value="8"/>
      <span id="brushSizeValue">8</span>
    </div>
    <div class="setting-item">
      <label>Smoothing:</label>
      <input type="range" id="smoothing" min="0.05" max="0.9" step="0.05" value="0.35"/>
      <span id="smoothingValue">35%</span>
    </div>
  </div>

  <div id="status" class="status">Initializing...</div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

  <script>
  class BodyDrawingBoard {
    constructor(){
      // Core elements
      this.video = document.getElementById('video');
      this.drawingCanvas = document.getElementById('drawingCanvas');
      this.drawingCtx = this.drawingCanvas.getContext('2d');
      this.mainContainer = document.getElementById('mainContainer');
      this.crosshair = document.getElementById('crosshair');
      this.loading = document.getElementById('loading');
      this.status = document.getElementById('status');
      this.instructions = document.getElementById('instructions');
      this.backgroundMusic = document.getElementById('backgroundMusic');

      // Controls
      this.clearBtn = document.getElementById('clearBtn');
      this.calibrateBtn = document.getElementById('calibrateBtn');

      // Settings
      this.brushSizeSlider = document.getElementById('brushSize');
      this.brushSizeValue  = document.getElementById('brushSizeValue');
      this.colorPicker = document.getElementById('colorPicker');
      this.smoothingSlider = document.getElementById('smoothing');
      this.smoothingValue  = document.getElementById('smoothingValue');
      
      // State
      this.lastPoint = null;
      this.smoothed = {x:0, y:0};
      
      // Camera/ML state
      this.pose = null;
      this.camera = null;

      this.bindUI();
      this.updateInstructions();
      this.initCameraSystem();
      window.addEventListener('resize', ()=>this.resizeCanvas());
    }

    bindUI(){
      this.clearBtn.addEventListener('click', () => { 
        this.drawingCtx.clearRect(0, 0, this.drawingCanvas.width, this.drawingCanvas.height);
        this.lastPoint = null;
        this.setStatus('Canvas cleared!');
      });
      
      this.calibrateBtn.addEventListener('click', () => {
        this.lastPoint = null;
        this.smoothed = {x:0, y:0};
        this.setStatus('Pointer state recalibrated.');
      });

      this.brushSizeSlider.addEventListener('input', e => this.brushSizeValue.textContent = e.target.value);
      this.smoothingSlider.addEventListener('input', e => this.smoothingValue.textContent = `${Math.round(parseFloat(e.target.value)*100)}%`);
    }

    updateInstructions() {
        let html = '<h3></h3>';
        this.instructions.innerHTML = html;
    }

    resizeCanvas(){
      this.drawingCanvas.width = this.mainContainer.clientWidth;
      this.drawingCanvas.height = this.mainContainer.clientHeight;
      // After resizing, clear the canvas
      this.clearBtn.click();
    }
    
    // CAMERA & GESTURE LOGIC
    async initCameraSystem() {
      await this.initCamera();
      this.initPose();
    }
    
    async initCamera() {
      this.loading.style.display = 'block';
      this.loading.innerHTML = '<h3>Starting Camera...</h3><p>Please allow camera access</p>';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720, facingMode: 'user' } });
        this.video.srcObject = stream;
        await new Promise(res => this.video.onloadedmetadata = res);
        this.resizeCanvas();
        this.loading.style.display = 'none';
        this.setStatus('Camera started successfully.');
        
        if (this.backgroundMusic) {
            this.backgroundMusic.play().catch(e => console.warn("Background music failed to play:", e));
        }

      } catch (err) {
        this.loading.innerHTML = `<h3 style="color:red">Camera Error</h3><p>${err.message}</p>`;
        this.setStatus('Camera permission denied.');
      }
    }

    initPose() {
      this.pose = new Pose({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
      this.pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      this.pose.onResults(r => this.onPoseResults(r));
      
      this.camera = new Camera(this.video, { 
        onFrame: async () => { await this.pose.send({ image: this.video }); }, 
        width: 1280, 
        height: 720 
      });
      this.camera.start();
      this.setStatus('Pose detection model loaded.');
    }

    onPoseResults(results) {
      if (!results.poseLandmarks) {
        this.crosshair.classList.remove('active');
        this.lastPoint = null;
        return;
      }
      
      const lm = results.poseLandmarks;
      const indexTip = lm[20]; // Right index finger
      const elbow = lm[14];     // Right elbow
      
      let activePoint = null;
      let activeLandmark = null;

      // Prioritize index finger, fall back to elbow
      if (indexTip && indexTip.visibility > 0.7) {
        activeLandmark = indexTip;
        this.setStatus("Drawing with: Right Hand");
      } else if (elbow && elbow.visibility > 0.8) {
        activeLandmark = elbow;
        this.setStatus("Drawing with: Right Elbow");
      }

      if (activeLandmark) {
        const pt = { 
            x: (1 - activeLandmark.x) * this.drawingCanvas.width, 
            y: activeLandmark.y * this.drawingCanvas.height 
        };

        const s = parseFloat(this.smoothingSlider.value);
        this.smoothed.x = this.lastPoint ? (this.smoothed.x * s + pt.x * (1 - s)) : pt.x;
        this.smoothed.y = this.lastPoint ? (this.smoothed.y * s + pt.y * (1 - s)) : pt.y;
        
        this.updateCrosshair(this.smoothed);
        this.drawAtPoint(this.smoothed);
        this.lastPoint = { ...this.smoothed };
      } else {
        this.crosshair.classList.remove('active');
        this.lastPoint = null; // Stop drawing if neither is visible
        this.setStatus("No valid drawing point detected.");
      }
    }

    // UNIVERSAL DRAWING FUNCTION
    drawAtPoint(p, isSingleClick = false) {
      const size = parseInt(this.brushSizeSlider.value);
      const color = this.colorPicker.value;
      this.drawingCtx.strokeStyle = color;
      this.drawingCtx.lineWidth = size;
      this.drawingCtx.lineCap = 'round';

      if (this.lastPoint && !isSingleClick) {
        this.drawingCtx.beginPath();
        this.drawingCtx.moveTo(this.lastPoint.x, this.lastPoint.y);
        this.drawingCtx.lineTo(p.x, p.y);
        this.drawingCtx.stroke();
      } else {
        this.drawingCtx.beginPath();
        this.drawingCtx.arc(p.x, p.y, size / 2, 0, Math.PI * 2);
        this.drawingCtx.fillStyle = color;
        this.drawingCtx.fill();
      }
    }
    
    updateCrosshair(p) {
      this.crosshair.style.left = `${p.x}px`;
      this.crosshair.style.top = `${p.y}px`;
      this.crosshair.classList.add('active');
    }
    
    setStatus(msg) { this.status.textContent = msg; }
  }

  window.addEventListener('DOMContentLoaded', () => new BodyDrawingBoard());
  </script>
</body>
</html>