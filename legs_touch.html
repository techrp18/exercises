<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Foot Touch - Leaning Game</title>

<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: Arial, sans-serif; overflow:hidden; background:#1a1a1a; }

  #video {
    position: absolute; top:0; left:0;
    width:100vw; height:100vh; object-fit:cover;
    transform: scaleX(-1); /* mirror */
    z-index:0;
  }
  
  #gameCanvas {
    position: absolute; top:0; left:0;
    width:100vw; height:100vh;
    z-index: 10;
  }

  #ui {
    position:absolute; left:20px; top:20px; z-index:20;
    background: rgba(0,0,0,0.75); color:#fff; padding:14px; border-radius:12px;
    min-width:260px; font-size:15px;
  }
  #controls {
    position:absolute; left:50%; transform:translateX(-50%); bottom:18px; z-index:20; display:flex; gap:10px;
  }
  button {
    background: linear-gradient(45deg,#5f27cd,#9d4edd); color:#fff; border:0; padding:10px 16px; border-radius:20px;
    cursor:pointer; font-weight:700; box-shadow:0 6px 18px rgba(0,0,0,0.18);
  }
  button:hover { transform: translateY(-3px); }

  #status {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:20;
    color:#fff; text-align:center; background: rgba(0,0,0,0.7); padding:18px; border-radius:12px; max-width:640px;
  }

  .point-popup {
    position:absolute; z-index:30;
    color: #feca57;
    font-weight:800; font-size: 28px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
    animation: fadeUpAndOut 2.5s ease-out forwards; /* Increased duration */
  }

  @keyframes fadeUpAndOut {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    80% { transform: translateY(0) scale(1); opacity: 1; } /* Hold on screen */
    100% { transform: translateY(-70px) scale(1.3); opacity: 0; }
  }

  /* Celebration Styles */
  .celebration-message {
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); z-index:100;
    background: linear-gradient(45deg, #9d4edd, #5f27cd); color:#fff;
    padding: 25px 35px; border-radius:20px; font-weight:700; font-size: 2.8em;
    animation: celebrationPop 3s ease-in-out forwards;
    box-shadow: 0 10px 30px rgba(0,0,0,0.4);
  }
  @keyframes celebrationPop {
    0% { transform:translate(-50%,-50%) scale(0); opacity:0; }
    10% { transform:translate(-50%,-50%) scale(1.1); opacity:1; }
    85% { transform:translate(-50%,-50%) scale(1.0); opacity:1; }
    100% { transform:translate(-50%,-50%) scale(0.9); opacity:0; }
  }
  .confetti {
    position: absolute;
    width: 10px;
    height: 10px;
    opacity: 0;
    z-index: 99;
    animation: confetti-fall 2.5s ease-out forwards;
  }
  @keyframes confetti-fall {
    0% { transform: translateY(-100px) rotateZ(0deg); opacity: 1; }
    100% { transform: translateY(300px) rotateZ(360deg); opacity: 0; }
  }
</style>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="gameCanvas"></canvas>
  
  <audio id="backgroundMusic" src="musicbg.mp3" loop preload="auto"></audio>
  <audio id="celebrationSound" src="audio.mp3" preload="auto"></audio>

  <div id="ui">
    <div><strong>üéØ Score:</strong> <span id="score">0</span></div>
    <div><strong>üèÜ High Score:</strong> <span id="highScore">0</span></div>
    <div><strong>üßç Pose Status:</strong> <span id="poseStatus">Not Detected</span></div>
  </div>

  <div id="controls">
    <button id="startBtn" onclick="game.startGame()">üéÆ Start Game</button>
    <button id="resetBtn" onclick="game.resetGame()">üîÑ Reset Game</button>
  </div>

  <div id="status">
    <h2>ü¶∂ Foot Touch Game</h2>
    <p>Lean left and right to touch the vertical lines with your feet. Each touch scores points and moves the line further away!</p>
  </div>

<script>
class FootTouchGame {
  constructor() {
    this.video = document.getElementById('video');
    this.canvas = document.getElementById('gameCanvas');
    this.ctx = this.canvas.getContext('2d');

    this.gameStarted = false;
    this.score = 0;
    this.highScore = localStorage.getItem('footTouchHighScore') || 0;
    document.getElementById('highScore').textContent = this.highScore;

    // Audio elements
    this.backgroundMusic = document.getElementById('backgroundMusic');
    this.celebrationSound = document.getElementById('celebrationSound');
    
    // Pose tracking state
    this.leftFoot = { x: 0, y: 0, detected: false };
    this.rightFoot = { x: 0, y: 0, detected: false };

    // Game elements state
    this.initialLineDist = window.innerWidth / 5;
    this.lineIncrease = 20; // How much the line moves out on touch
    this.collisionThreshold = 25;

    this.leftLine = { dist: this.initialLineDist, x: 0, active: true };
    this.rightLine = { dist: this.initialLineDist, x: 0, active: true };
    this.confettiColors = ['#9d4edd', '#feca57', '#5f27cd', '#ffffff'];

    
    window.addEventListener('resize', this.resizeCanvas.bind(this));
  }

  resizeCanvas() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
    this.initialLineDist = window.innerWidth / 5;
    // Re-calculate line positions on resize
    this.leftLine.x = this.canvas.width / 2 - this.leftLine.dist;
    this.rightLine.x = this.canvas.width / 2 + this.rightLine.dist;
  }

  async startGame() {
    if (this.gameStarted) return;
    try {
      document.getElementById('status').style.display = 'none';
      this.resizeCanvas();

      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      this.video.srcObject = stream;
      await new Promise(resolve => { this.video.onloadeddata = () => resolve(); });

      const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
      pose.onResults(this.onPoseResults.bind(this));

      const camera = new Camera(this.video, {
        onFrame: async () => await pose.send({image: this.video}),
        width: 1280,
        height: 720
      });
      camera.start();

      if (this.backgroundMusic) {
          this.backgroundMusic.play().catch(e => console.warn("Background music failed to play:", e));
      }

      this.gameStarted = true;
      document.getElementById('startBtn').textContent = '‚úÖ Camera Active';
      document.getElementById('startBtn').disabled = true;

      this.gameLoop();

    } catch (err) {
      console.error('startGame error', err);
      alert('Could not start camera ‚Äî please allow permissions and try again.');
    }
  }

  onPoseResults(results) {
    if (results.poseLandmarks) {
      document.getElementById('poseStatus').textContent = 'Detected';
      const videoRect = this.video.getBoundingClientRect();
      
      const lm_left_foot = results.poseLandmarks[31]; // Left Foot Index
      const lm_right_foot = results.poseLandmarks[32]; // Right Foot Index

      // Convert to screen coords, mirroring X
      this.leftFoot = {
          x: videoRect.left + (1 - lm_left_foot.x) * videoRect.width,
          y: videoRect.top + lm_left_foot.y * videoRect.height,
          detected: lm_left_foot.visibility > 0.5
      };

      this.rightFoot = {
          x: videoRect.left + (1 - lm_right_foot.x) * videoRect.width,
          y: videoRect.top + lm_right_foot.y * videoRect.height,
          detected: lm_right_foot.visibility > 0.5
      };
    } else {
      document.getElementById('poseStatus').textContent = 'Not Detected';
      this.leftFoot.detected = false;
      this.rightFoot.detected = false;
    }
  }

  updateGameLogic() {
    if (!this.gameStarted) return;
    const centerX = this.canvas.width / 2;
    this.leftLine.x = centerX - this.leftLine.dist;
    this.rightLine.x = centerX + this.rightLine.dist;

    // Check for left foot collision
    if (this.leftFoot.detected && this.leftLine.active && Math.abs(this.leftFoot.x - this.leftLine.x) < this.collisionThreshold) {
        this.handleCollision('left');
    }

    // Check for right foot collision
    if (this.rightFoot.detected && this.rightLine.active && Math.abs(this.rightFoot.x - this.rightLine.x) < this.collisionThreshold) {
        this.handleCollision('right');
    }
  }

  handleCollision(side) {
    const points = 25; // Increased points
    this.addScore(points);
    this.showCelebration(points);
    
    if (side === 'left') {
        this.leftLine.active = false;
        this.leftLine.dist += this.lineIncrease;
        this.showPointsPopup(points, this.leftLine.x, this.leftFoot.y);
        setTimeout(() => { this.leftLine.active = true; }, 1000); // 1 second cooldown
    } else {
        this.rightLine.active = false;
        this.rightLine.dist += this.lineIncrease;
        this.showPointsPopup(points, this.rightLine.x, this.rightFoot.y);
        setTimeout(() => { this.rightLine.active = true; }, 1000); // 1 second cooldown
    }
  }

  addScore(points) {
    this.score += points;
    if (this.score > this.highScore) {
        this.highScore = this.score;
        localStorage.setItem('footTouchHighScore', this.highScore);
    }
    this.updateUI();
  }

  showPointsPopup(points, x, y) {
    const popup = document.createElement('div');
    popup.className = 'point-popup';
    popup.textContent = `+${points}`;
    popup.style.left = `${x}px`;
    popup.style.top = `${y}px`;
    document.body.appendChild(popup);
    setTimeout(() => popup.remove(), 2400); // Increased removal time
  }

  showCelebration(points) {
      if (this.celebrationSound) {
          this.celebrationSound.currentTime = 0;
          this.celebrationSound.play();
      }
      
      const el = document.createElement('div');
      el.className = 'celebration-message';
      el.textContent = `‚≠ê +${points}! ‚≠ê`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2900);

      // Create confetti
      for (let i = 0; i < 40; i++) {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          const startX = (Math.random() - 0.5) * window.innerWidth * 0.7;
          const startY = (Math.random() - 0.5) * window.innerHeight * 0.7;
          confetti.style.left = `calc(50% + ${startX}px)`;
          confetti.style.top = `calc(50% + ${startY}px)`;
          confetti.style.backgroundColor = this.confettiColors[Math.floor(Math.random() * this.confettiColors.length)];
          confetti.style.animationDelay = `${Math.random() * 0.2}s`;
          confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
          document.body.appendChild(confetti);
          setTimeout(() => confetti.remove(), 2500);
      }
  }


  updateUI() {
    document.getElementById('score').textContent = this.score;
    document.getElementById('highScore').textContent = this.highScore;
  }

  draw() {
    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

    // Draw target lines
    this.ctx.lineWidth = 10;
    this.ctx.lineCap = 'round';
    // Left Line
    this.ctx.strokeStyle = this.leftLine.active ? 'rgba(157, 78, 221, 0.9)' : 'rgba(255, 82, 82, 0.8)';
    this.ctx.beginPath();
    this.ctx.moveTo(this.leftLine.x, 0);
    this.ctx.lineTo(this.leftLine.x, this.canvas.height);
    this.ctx.stroke();
    // Right Line
    this.ctx.strokeStyle = this.rightLine.active ? 'rgba(157, 78, 221, 0.9)' : 'rgba(255, 82, 82, 0.8)';
    this.ctx.beginPath();
    this.ctx.moveTo(this.rightLine.x, 0);
    this.ctx.lineTo(this.rightLine.x, this.canvas.height);
    this.ctx.stroke();

    // Draw foot cursors as vertical lines
    const footLineHeight = 100; // Height of the vertical line
    this.ctx.lineWidth = 8;        // Thickness of the line
    this.ctx.lineCap = 'round';

    if (this.leftFoot.detected) {
        this.ctx.strokeStyle = "rgba(254, 202, 87, 0.8)"; // Yellow for left
        this.ctx.beginPath();
        // Draw line centered on the foot's y-position
        this.ctx.moveTo(this.leftFoot.x, this.leftFoot.y - footLineHeight / 2);
        this.ctx.lineTo(this.leftFoot.x, this.leftFoot.y + footLineHeight / 2);
        this.ctx.stroke();
    }
    if (this.rightFoot.detected) {
        this.ctx.strokeStyle = "rgba(255, 107, 107, 0.8)"; // Red for right
        this.ctx.beginPath();
        // Draw line centered on the foot's y-position
        this.ctx.moveTo(this.rightFoot.x, this.rightFoot.y - footLineHeight / 2);
        this.ctx.lineTo(this.rightFoot.x, this.rightFoot.y + footLineHeight / 2);
        this.ctx.stroke();
    }
  }
  
  resetGame() {
    if (!this.gameStarted) {
        alert("Start the game first before resetting!");
        return;
    }
    this.score = 0;
    this.leftLine.dist = this.initialLineDist;
    this.rightLine.dist = this.initialLineDist;
    this.leftLine.active = true;
    this.rightLine.active = true;
    this.updateUI();
  }

  gameLoop() {
    this.updateGameLogic();
    this.draw();
    if(this.gameStarted) {
        requestAnimationFrame(this.gameLoop.bind(this));
    }
  }
}

const game = new FootTouchGame();
</script>
</body>
</html>